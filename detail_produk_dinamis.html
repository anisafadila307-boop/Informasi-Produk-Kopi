<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detail Produk Kopi</title>
  <style>
  body {
    margin:0;
    background: linear-gradient(180deg,#071029 0%,#071827 60%);
    color:#e6eef8;
    font-family: 'Segoe UI', sans-serif;
  }
  .detail-premium { min-height:100vh; padding:40px 20px; }
  .container-prem { max-width:1100px; margin:0 auto; }
  header.hero { display:flex; gap:20px; align-items:center; }
  .img-hero{ width:140px; height:140px; border-radius:10px; object-fit:cover; box-shadow:0 8px 30px rgba(0,0,0,0.6); border:2px solid rgba(255,255,255,0.03); }
  .badge { background: rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; color:#94a3b8; font-size:13px; display:inline-block; }
  h1.pm-title { margin:0; font-size:22px; color:#fff; }
  .sub { color:#94a3b8; margin-top:6px; }
  .meta-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; }
  .pill { background: rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; font-size:13px; color:#e6eef8; }
  .grid { display:grid; grid-template-columns:1fr 360px; gap:20px; margin-top:22px; align-items:start; }
  .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(2,6,23,0.6); color:inherit; }
  .card h3{ margin:0 0 12px 0; color:#fff; }
  dl { display:grid; grid-template-columns:140px 1fr; gap:8px 16px; color:#e6eef8; }
  dt { color:#94a3b8; font-size:13px; }
  dd { margin:0; }
  footer.pm-foot { margin-top:18px; color:#94a3b8; font-size:13px; text-align:center; }
  .charts { display:grid; grid-template-columns:1fr 1fr; gap:14px; margin-top:8px; }
  @media (max-width:900px){ .grid{ grid-template-columns:1fr; } .charts{ grid-template-columns:1fr; } }
  .back-prem { background:#081018; color:#e6eef8; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; margin-bottom:14px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
  <div class="detail-premium" id="pageDetail">
    <div class="container-prem">
      <button class="back-prem" id="btnKembali">← Kembali ke Daftar Produk</button>

      <header class="hero">
        <img id="detailImgHero" class="img-hero" src="" alt="Gambar Produk">
        <div>
          <div class="badge" id="detailBadge">Single Origin • Arabica</div>
          <h1 class="pm-title" id="detailNama">Nama Produk</h1>
          <div class="sub" id="detailSub">Subjudul / ringkasan singkat</div>

          <div class="meta-row">
            <div class="pill" id="pillAsal"></div>
            <div class="pill" id="pillHarga"></div>
            <div class="pill" id="pillJenis"></div>
          </div>
        </div>
      </header>

      <div class="grid">
        <main>
          <section class="card">
            <h3>Deskripsi</h3>
            <p id="detailRingkasan" class="muted">Deskripsi tentang produk — diisi dari localStorage.</p>
            <hr style="opacity:0.06;margin:14px 0">

            <div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap">
              <div style="flex:1;min-width:240px">
                <h3>Profil Cita Rasa</h3>
                <div class="taste-list" id="tastePills"></div>
              </div>

              <div style="flex:1;min-width:240px">
                <h3>Spesifikasi</h3>
                <dl id="dlQuality">
                  <dt>Grade</dt><dd id="dlGrade">—</dd>
                  <dt>Kadar Air (Moisture)</dt><dd id="dlMoisture">—</dd>
                  <dt>Defects</dt><dd id="dlDefect">—</dd>
                  <dt>Ukuran (Screen Size)</dt><dd id="dlScreen">—</dd>
                </dl>
              </div>
            </div>
          </section>

          <section class="card" style="margin-top:14px">
            <h3>Visualisasi Profil Rasa</h3>
            <div class="charts">
              <div><canvas id="radarTaste"></canvas></div>
              <div><canvas id="barRoast"></canvas></div>
            </div>
          </section>
        </main>

        <aside>
          <div class="card">
            <h3>Ringkasan Cepat</h3>
            <dl>
              <dt>Nama</dt><dd id="asideNama">—</dd>
              <dt>Asal</dt><dd id="asideAsal">—</dd>
              <dt>Harga/kg</dt><dd id="asideHarga">—</dd>
            </dl>

            <div id="qrContainer" style="margin-top:16px; text-align:center;"></div>
            <div id="downloadContainer" style="margin-top:10px; text-align:center;"></div>
          </div>

          <div class="card" style="margin-top:14px">
            <h3>Keyword & Tag</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap" id="tagList"></div>
          </div>
        </aside>
      </div>

      <footer class="pm-foot">Informasi ini adalah deskriptif. Data teknis dan rekomendasi dihasilkan otomatis dari input produk.</footer>
    </div>
  </div>

<script>
// === JS dari detail_logic.js + logika kembali otomatis ===
function mapKeasamanToScore(t){t=(t||"").toLowerCase();if(t.includes('tinggi'))return 8;if(t.includes('sedang'))return 5;if(t.includes('rendah'))return 2;return 5;}
function mapBodyToScore(t){t=(t||"").toLowerCase();if(t.includes('penuh'))return 9;if(t.includes('sedang'))return 6;if(t.includes('ringan'))return 3;return 5;}
function analyzeAromaRasa(a,r){a=(a||"").toLowerCase();r=(r||"").toLowerCase();let aromaScore=5;['floral','fruity','nutty','chocolate','cocoa','caramel','herbal','spice','citrus','vanilla','berry'].forEach(k=>{if(a.includes(k))aromaScore++;if(r.includes(k))aromaScore+=0.6;});aromaScore=Math.min(10,Math.max(0,Math.round(aromaScore)));let sweetness=4;['caramel','honey','sweet','sugar','chocolate','cocoa','vanilla','fruit','fruity','berry'].forEach(k=>{if(r.includes(k)||a.includes(k))sweetness++;});let aftertaste=5;if(r.includes('panjang'))aftertaste=8;if(r.includes('pendek'))aftertaste=3;return{aromaScore,sweetness,aftertaste};}
function computeRoastSuitability(b,a){const light=Math.round((10-b)*8+a*3);const medium=Math.round((10-Math.abs(b-6))*6+a*2);const medDark=Math.round(b*7-a*1.5);const dark=Math.round(b*6+(10-a)*2);const arr=[light,medium,medDark,dark];const max=Math.max(...arr,1);return arr.map(v=>Math.round((v/max)*100));}

function renderRadar(values){
  const ctx=document.getElementById('radarTaste').getContext('2d');
  if(window.radarChart)window.radarChart.destroy();
  window.radarChart=new Chart(ctx,{
    type:'radar',
    data:{labels:['Sweetness','Acidity','Body','Aroma','Aftertaste'],
      datasets:[{data:values,fill:true,backgroundColor:'rgba(199,123,0,0.18)',borderColor:'rgba(199,123,0,0.9)',pointBackgroundColor:'rgba(199,123,0,0.9)'}]},
    options:{scales:{r:{beginAtZero:true,max:10,grid:{color:'rgba(255,255,255,0.04)'},angleLines:{color:'rgba(255,255,255,0.03)'}}},plugins:{legend:{display:false}}}
  });
}

function renderBar(vals){
  const ctx=document.getElementById('barRoast').getContext('2d');
  if(window.barChart)window.barChart.destroy();
  window.barChart=new Chart(ctx,{
    type:'bar',
    data:{labels:['Light','Medium','Medium-Dark','Dark'],datasets:[{data:vals,borderRadius:6,backgroundColor:'rgba(199,123,0,0.9)'}]},
    options:{scales:{y:{beginAtZero:true,max:100}},plugins:{legend:{display:false}}}
  });
}

function tampilkanProduk(produk){
  if(!produk){ alert('Data produk tidak ditemukan.'); return; }
  document.getElementById('detailNama').textContent = produk.nama || '—';
  document.getElementById('detailSub').textContent = (produk.jenis || '') + " • " + (produk.asal || '');
  document.getElementById('detailImgHero').src = produk.gambarProfil || 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?q=80&w=800&auto=format';
  document.getElementById('pillAsal').textContent = produk.asal || '—';
  document.getElementById('pillHarga').textContent = "Rp " + Number(produk.harga||0).toLocaleString('id');
  document.getElementById('pillJenis').textContent = produk.jenis || '—';
  document.getElementById('detailRingkasan').textContent = produk.deskripsi || '—';
  document.getElementById('asideNama').textContent = produk.nama || '—';
  document.getElementById('asideAsal').textContent = produk.asal || '—';
  document.getElementById('asideHarga').textContent = "Rp " + Number(produk.harga||0).toLocaleString('id');
  document.getElementById('dlGrade').textContent = produk.grade || '—';
  document.getElementById('dlMoisture').textContent = produk.moisture || '—';
  document.getElementById('dlDefect').textContent = produk.defect || '—';
  document.getElementById('dlScreen').textContent = produk.ukuran || '—';

  const tagList = document.getElementById('tagList');
  tagList.innerHTML = '';
  [produk.jenis, produk.asal, 'Product'].forEach(t=>{ if(t){ const s=document.createElement('span'); s.className='pill'; s.textContent=t; tagList.appendChild(s);} });

  const tastePills = document.getElementById('tastePills');
  tastePills.innerHTML = '';
  ['Body: '+(produk.body||'—'), 'Keasaman: '+(produk.keasaman||'—'), 'Aroma: '+(produk.aroma||'—'), 'Rasa: '+(produk.rasa||'—')].forEach(p=>{
    const el=document.createElement('span');el.className='pill';el.textContent=p;tastePills.appendChild(el);
  });

  const acidityScore = mapKeasamanToScore(produk.keasaman);
  const bodyScore = mapBodyToScore(produk.body);
  const { aromaScore, sweetness, aftertaste } = analyzeAromaRasa(produk.aroma, produk.rasa);
  const radarData = [sweetness, acidityScore, bodyScore, aromaScore, aftertaste];
  const roastVals = computeRoastSuitability(bodyScore, acidityScore);
  renderRadar(radarData);
  renderBar(roastVals);

  // QR
  const qrContainer = document.getElementById('qrContainer');
  qrContainer.innerHTML = '';
  const slug = (produk.nama||'produk').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');
  const url = `https://kopi.id/produk/${slug}`;
  new QRCode(qrContainer, { text: url, width: 160, height: 160, colorDark: "#000000", colorLight: "#ffffff" });
  const downloadContainer = document.getElementById('downloadContainer');
  downloadContainer.innerHTML = '';
  const btn = document.createElement('button');
  btn.textContent = "📥 Unduh QR Produk";
  btn.style.background="#d7b899";btn.style.color="#3e2723";btn.style.border="none";btn.style.padding="8px 12px";btn.style.borderRadius="8px";btn.style.cursor="pointer";
  btn.onclick = () => {
    const img = qrContainer.querySelector("img")||qrContainer.querySelector("canvas");
    if(img){
      const a = document.createElement('a');
      a.href = img.src || img.toDataURL("image/png");
      a.download = slug + "-qr.png";
      a.click();
    }
  };
  downloadContainer.appendChild(btn);
}



window.addEventListener('load', ()=>{
  const produk = JSON.parse(localStorage.getItem('produkDetail') || 'null');
  if (produk) tampilkanProduk(produk);
  else {
    const all = JSON.parse(localStorage.getItem('produkKopiLengkap_v3') || '[]');
    if(all && all.length) tampilkanProduk(all.slice(-1)[0]);
    else alert('Data produk tidak ditemukan.');
  }
});

// Jalankan seluruh logika setelah DOM siap
window.addEventListener('DOMContentLoaded', () => {
  // Pastikan tombol "Kembali" sudah ada
  const btnKembali = document.getElementById('btnKembali');
  if (!btnKembali) return; // Jika tombol tidak ditemukan, hentikan fungsi

  // Pasang event listener setelah tombol terdeteksi
  btnKembali.addEventListener('click', () => {
    const sudahLogin = localStorage.getItem("isLoggedIn");
    const lastPage = localStorage.getItem("lastPage");

    console.log("Status login:", sudahLogin, "Last page:", lastPage); // untuk debugging

    if (sudahLogin === "true") {
      window.location.href = "2dashboard_internal.html";
    } else if (lastPage) {
      window.location.href = lastPage;
    } else {
      window.location.href = "index.html";
    }
  });
});

</script>
</body>
</html>
